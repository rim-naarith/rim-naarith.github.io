<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Game (P2P WebRTC)</title>
    <style>
        canvas {
            background: #ddd;
            display: block;
            margin: auto;
        }
    </style>
</head>

<body>
    <h1>Multiplayer Game (P2P WebRTC)</h1>
    <button id="hostBtn">Host Game</button>
    <input id="peerIdInput" placeholder="Enter Host ID">
    <button id="joinBtn">Join Game</button>
    <p>Your ID: <span id="playerId">-</span></p>
    <canvas id="gameCanvas" width="500" height="500"></canvas>

    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let players = {};  // Store player positions
        let peer, connections = {};

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let id in players) {
                const p = players[id];
                ctx.fillStyle = id === peer.id ? "blue" : "red"; // Different color for self
                ctx.fillRect(p.x, p.y, 20, 20);
            }
        }

        function updatePosition(x, y) {
            if (!peer || !peer.id) return;
            players[peer.id] = { x, y };
            for (let id in connections) {
                connections[id].send({ id: peer.id, x, y }); // Send movement to all players
            }
            drawGame();
        }

        function setupHost() {
            peer = new Peer();
            peer.on('open', id => document.getElementById('playerId').textContent = id);

            peer.on('connection', conn => {
                connections[conn.peer] = conn;

                // Send existing players to the new player
                conn.send({ type: "existingPlayers", players });

                // Notify all players about the new one
                for (let id in connections) {
                    connections[id].send({ type: "newPlayer", id: conn.peer });
                }

                // Handle incoming data (player movement)
                conn.on('data', data => {
                    players[data.id] = data;
                    broadcast(data); // Send updated position to all players
                });

                console.log("New player connected:", conn.peer);
            });
        }

        // Broadcast data to all players
        function broadcast(data) {
            for (let id in connections) {
                connections[id].send(data);
            }
        }


        function joinGame() {
            const hostId = document.getElementById('peerIdInput').value;
            if (!hostId) return alert("Enter a valid Host ID!");

            peer = new Peer();
            peer.on('open', id => document.getElementById('playerId').textContent = id);

            peer.on('open', () => {
                let conn = peer.connect(hostId);
                connections[hostId] = conn;

                conn.on('open', () => console.log("Connected to host:", hostId));

                conn.on('data', data => {
                    if (data.type === "existingPlayers") {
                        players = { ...data.players }; // Sync existing players
                    } else if (data.type === "newPlayer") {
                        players[data.id] = { x: 50, y: 50 }; // Default position
                    } else {
                        players[data.id] = data; // Update positions
                    }
                    drawGame();
                });
            });
        }


        document.getElementById('hostBtn').addEventListener('click', setupHost);
        document.getElementById('joinBtn').addEventListener('click', joinGame);

        window.addEventListener('keydown', (e) => {
            const step = 10;
            let { x, y } = players[peer.id] || { x: 50, y: 50 };
            if (e.key === 'ArrowUp') y -= step;
            if (e.key === 'ArrowDown') y += step;
            if (e.key === 'ArrowLeft') x -= step;
            if (e.key === 'ArrowRight') x += step;
            updatePosition(x, y);
        });
    </script>
</body>

</html>